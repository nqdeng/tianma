配置文件
-------------------

编写配置文件时需要按以下步骤做三件事情：

1. 创建*主机*（Host）。

2. 在主机上创建*流水线*（Pipeline）。

3. 在流水线上使用*模块*（Filter）。

### 创建主机

主机是提供服务的基本单元，可以通过`tianma()`函数创建。

	var tianma = require('tianma')

	tianma(config)   // 创建一个主机

#### 监听端口

一个主机可以监听一个HTTP端口，通过`port`来指定。

	tianma({ port: 8080 })

其它配置都使用默认值时，也可以使用以下*快捷配置*：

	tianma(8080)

HTTP端口也使用默认值`80`时，配置可进一步简化如下：

	tianma()

#### IP绑定

当服务器上有多个IP时，可以通过`ip`来指定绑定哪个IP提供服务。未指定时，绑定所有IP。

	tianma({ ip: '127.0.0.1', port: 80 })

#### 编码

可以通过`charset`来指定主机在处理HTTP请求和响应时使用的文本编码。未指定时，默认使用`utf-8`。天马支持的编码类型请参考[iconv-lite](https://github.com/ashtuchkin/iconv-lite#supported-encodings)。

	tianma({ charset: 'gbk', port: 80 })

#### HTTPS

一个主机同时也可以监听一个HTTPS端口，通过`portssl`来指定。

	tianma({ portssl: 443 })

天马使用*自制证书*提供HTTPS服务，为了避免浏览器安全警告，可以在浏览器中安装*天马根证书*（`{全局目录}/certificates/tianma.cer`）。

+ IE

	双击`tianma.cer`，在弹出的对话框中选择*安装证书*，证书安装位置手动指定为*受信任的根证书颁发机构*，完成。

+ Chrome

	Windows下Chrome与IE共用一套证书系统，只需完成IE的安装步骤即可。Linux下按照*设置* -> *显示高级设置* -> *管理证书*的顺序打开对话框后，按照类似IE下的步骤安装根证书。

+ Firefox

	按照*选项* -> *高级* -> *加密* -> *查看证书* -> *认证* -> *导入*的顺序，打开`tianma.cer`之后，在弹出的对话框中勾选上*使用该证书认证网站*，完成。

+ 其它浏览器

	请依葫芦画瓢。

>	天马通过[SNI](http://en.wikipedia.org/wiki/Server_Name_Indication)技术同时为多个域名提供HTTPS服务，并且*动态地*为不同域名生成基于天马根证书签发的子证书。

### 创建流水线

一个主机上需要使用`mount`方法创建一到多条流水线，主机在收到一个HTTP请求时，会交由与之匹配的流水线处理。

	tianma()
		.mount('foo.example.com')   // 创建一条流水线
			.static('./foo')
		.mount('bar.example.com')   // 创建另一条流水线
			.static('./bar')

#### 路由规则

使用`mount`方法创建流水线的同时，也定义了相应的路由规则。路由规则由*域名*和*路径*组成，支持通配符`*`和`?`。省略域名时，默认值为`*`，省略路径时，默认值为`/`。

+	`*`: 使用非贪婪模式匹配一到多个字符。
+	`?`: 匹配一个字符。

HTTP请求按以下原则与路由规则匹配：

+	*域名*优先于*路径*。

+	*具体*规则优先于*通配*规则。

以下是一些路由规则（左）和匹配结果（右）的例子：

	tianma()
	    .mount('*.example.com')         // 匹配'http://www.example.com/foo'
			.static('./example')
	    .mount('www.example.com/ba?/')  // 匹配'http://www.example.com/bar/foo'
			.static('./example')
	    .mount('/')                     // 匹配'http://www.sample.com/foo'
			.static('./default')

#### 默认流水线

天马自带一条使用路由规则`/`的默认流水线，只需要使用默认流水线时，就可以省略`mount`方法，直接在默认流水线上使用模块。

	tianma()
		.static('./default')

	/* 等价于 */

	tianma()
		.mount('/')
			.static('./default')

### 使用模块

一条流水线上可以使用一到多个模块，以决定流水线如何处理HTTP请求。天马*内置*了若干常用模块，可以按照链式调用的方式，使用模块名作为方法名，在新创建的流水线上按顺序使用。

	tianma()
		.mount('www.example.com')
			.compress('html', 'js', 'css')  // 使用数据压缩模块
			.static('./htdocs');            // 使用静态文件服务模块

#### 模块层叠

一条流水线上的模块按照*使用顺序*层叠在一起，因此流水线在处理不同的HTTP请求时，有以下几种方式：

+ 一个模块可以在处理完请求之后*直接返回*响应，这时后续模块不发挥作用。

		         request response
		             v     ^   
		             |     |   
		+------------|-----|---------------------------------+
		| filter A   `-----`                                 |
		+----------------------------------------------------+
		| filter B                                           |
		+----------------------------------------------------+

+ 一个模块可以先对请求做*部分处理*后，再将请求*传递*给后续模块处理，并在后续模块*返回*响应后，再对响应做一些*二次加工*。

		          request           response
		             v                 ^
		             |                 |
		+------------|-----------------|---------------------+
		| filter A   `-----.     .-----`                     |
		+------------------|-----|---------------------------+
		| filter B         `-----`                           |
		+----------------------------------------------------+

+ 一个模块甚至可以对请求做一些处理后，*多次*将请求传递给后续模块处理并收集响应，并最终返回一个*总体*响应。

		          request                       response
		             v                             ^   
		             |                             |   
		+------------|-----------------------------|---------+
		| filter A   `-----.     .-----.     .-----`         |
		+------------------|-----|-----|-----|---------------+
		| filter B         `-----`     `-----`               |
		+----------------------------------------------------+

### 远程配置

如果需要统一维护一份*公用配置文件*提供给多人使用，就可以把配置文件存放在一台HTTP静态文件服务器上，这样的配置被称为*远程配置*。

#### 使用方法

通过`tianma(url)`函数可以加载和运行远程配置。

	tianma('http://www.example.com/some-config.js')

想要更安全时，也可以使用HTTPS协议。

	tianma('https://www.example.com/some-config.js')

远程配置需要使用者提供一些*参数*时，可以使用以下方式：

	tianma('http://www.example.com/some-config.js', {
		port: 8080,
		root: '/home/admin/www/htdocs'
	});

>	当存放在远程服务器上的配置文件的*最后修改日期*发生变动时，天马会*自动更新*本地缓存起来的配置文件。

#### 编写方法

编写远程配置的方法和普通配置文件类似，只不过远程配置中可通过全局变量`config`来访问使用者提供的参数。

	var tianma = require('tianma')

	tianma({ port: config.port || 80 })      // 允许使用者自定义HTTP端口
		.static(config.root || './htdocs')   // 允许使用者自定义静态文件服务根目录
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>天马使用手册</title>
<style>
html, body {
margin: 0;
padding: 0;
}

body {
background: #777;
font-family: sans-serif;
line-height: 170%;
}

header, nav, article, footer {
display: block;
}

#wrapper {
background: #fff;
margin: 0 auto;
max-width: 1200px;
}

#menu {
background: #000;
border-radius: 24px;
bottom: 30px;
display: none;
height: 48px;
opacity: 0.5;
position: fixed;
right: 30px;
transition: opacity 0.3s ease;
width: 48px;
}

#menu span {
background: #ccc;
display: block;
height: 3px;
margin: 5px auto;
width: 24px;
}

#menu span.first {
margin-top: 15px;
}

.show-menu #menu {
opacity: 0.75;
}

.show-menu #menu span {
background: #fff;
}

nav {
background: #fff;
border-right: 5px solid #777;
bottom: 0;
color: #333;
font-size: 10pt;
overflow-x: hidden;
overflow-y: auto;
padding: 20px 0 20px 40px;
position: fixed;
top: 0;
width: 195px;
}

nav ul {
margin: 0;
padding: 0;
}

nav a {
color: #777;
text-decoration: none;
}

nav a:hover {
text-decoration: underline;
}

nav li {
list-style: none;
margin: 0;
padding: 0;
}

nav .level2 {
font-size: 11pt;
font-weight: bold;
}

nav .level3 {
padding-left: 1em;
}

nav .level3:before { 
content: "» ";
}

nav .level4 {
padding-left: 2em;
}

nav .level4:before { 
content: "› ";
}

article {
color: #333;
font-size: 11pt;
margin-left: 240px;
padding: 40px;
word-break: break-all;
}

article .logo {
background: right top no-repeat url(data:image/png;base64,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);
float: right;
height: 160px;
margin-top: -30px;
width: 222px;
}

header {
border-bottom: solid 2px #333;
height: 90px;
margin-bottom: 30px;
}

header h1 {
color: #f60;
font-family: monospace;
font-size: 20pt;
margin: 0 0 2pt 0;
}

header h1 sup {
color: #f90;
font-size: 11pt;
}

header .link {
float: right;
font-size: 9pt;
}

header .comment {
color: #777;
font-family: monospace;
font-size: 10pt;
}

article h2 {
border-bottom: dotted 1px #777;
font-size: 16pt;
margin: 2em 0 1em;
padding: 0 0 0.3em 0;
}

article h2:before {
content: "# ";
}

article h3 {
font-size: 14pt;
margin: 1.5em 0 1em 0;
padding: 0;
}

article h4 {
font-size: 11pt;
margin: 1em 0;
padding: 0;
}

article a {
color: #06f;
font-weight: bold;
}

article p {
margin: 1em 0;
}

article p em {
border-bottom: 2px solid #f90;
font-style: normal;
}

article p strong {
border-bottom: 2px solid #c00;
}

article p code {
background: #eee;
border-radius: 5px;
font-size: 10pt;
padding: 0.2em;
}

article pre {
color: #666;
font-size: 10pt;
line-height: 140%;
margin: 1em 0;
overflow-x: auto;
overflow-y: padding;
padding: 0 2em;
}

article blockquote {
border-left: solid 2px #f90;
margin: 1em 0;
padding: 0 0 0 2em;
}

footer {
border-top: 1px solid #ccc;
font-size: 10pt;
font-weight: bold;
margin-top: 4em;
}

@media (max-width: 768px) {
	#menu {
	display: block;
	}

	nav {
	border-right: none;
	line-height: 240%;
	margin-left: -240px;
	transition: margin 0.3s ease;
	width: 200px;
	}

	.show-menu nav {
	box-shadow: 5px 5px 5px #777;
	margin-left: 0;
	}

	article {
	margin-left: 0;
	padding: 20px;
	}

	article .logo {
	right: 10px;
	}
}

@media (max-width: 480px) {
	article {
	padding: 10px;
	}

	article .logo {
	right: 0;
	}
}
</style>
<script>
(function (tags) {
	var i = 0, len = tags.length;

	for (; i < len; ++i) {
	    document.createElement(tags[i]);
	}
}([ 'header', 'nav', 'article', 'footer' ]));
</script>
</head>
<body>
<div id="wrapper">
<div id="menu">
<span class="first"></span>
<span></span>
<span></span>
</div>
<nav>
<ul>
<li class="level2"><a href="#1">入门</a></li><li class="level3"><a href="#1.1">安装</a></li><li class="level3"><a href="#1.2">使用</a></li><li class="level4"><a href="#1.2.1">工作目录</a></li><li class="level4"><a href="#1.2.2">配置文件</a></li><li class="level4"><a href="#1.2.3">启动和停止服务</a></li><li class="level2"><a href="#2">配置文件</a></li><li class="level3"><a href="#2.1">创建主机</a></li><li class="level4"><a href="#2.1.1">监听端口</a></li><li class="level4"><a href="#2.1.2">IP绑定</a></li><li class="level4"><a href="#2.1.3">编码</a></li><li class="level4"><a href="#2.1.4">HTTPS</a></li><li class="level3"><a href="#2.2">创建流水线</a></li><li class="level4"><a href="#2.2.1">路由规则</a></li><li class="level4"><a href="#2.2.2">默认流水线</a></li><li class="level3"><a href="#2.3">使用模块</a></li><li class="level4"><a href="#2.3.1">模块层叠</a></li><li class="level3"><a href="#2.4">远程配置</a></li><li class="level4"><a href="#2.4.1">使用方法</a></li><li class="level4"><a href="#2.4.2">编写方法</a></li><li class="level2"><a href="#3">内置模块</a></li><li class="level3"><a href="#3.1">cache</a></li><li class="level3"><a href="#3.2">combo</a></li><li class="level3"><a href="#3.3">compress</a></li><li class="level3"><a href="#3.4">rewrite</a></li><li class="level3"><a href="#3.5">static</a></li><li class="level3"><a href="#3.6">use</a></li><li class="level2"><a href="#4">自定义模块</a></li><li class="level3"><a href="#4.1">request</a></li><li class="level4"><a href="#4.1.1">.accepts</a></li><li class="level4"><a href="#4.1.2">.acceptsCharsets</a></li><li class="level4"><a href="#4.1.3">.acceptsEncodings</a></li><li class="level4"><a href="#4.1.4">.acceptsLanguages</a></li><li class="level4"><a href="#4.1.5">.charset</a></li><li class="level4"><a href="#4.1.6">.cookie</a></li><li class="level4"><a href="#4.1.7">.data</a></li><li class="level4"><a href="#4.1.8">.form</a></li><li class="level4"><a href="#4.1.9">.head</a></li><li class="level4"><a href="#4.1.10">.ip</a></li><li class="level4"><a href="#4.1.11">.is</a></li><li class="level4"><a href="#4.1.12">.method</a></li><li class="level4"><a href="#4.1.13">.toString</a></li><li class="level4"><a href="#4.1.14">.type</a></li><li class="level4"><a href="#4.1.15">.url</a></li><li class="level3"><a href="#4.2">response</a></li><li class="level4"><a href="#4.2.1">.charset</a></li><li class="level4"><a href="#4.2.2">.cookie</a></li><li class="level4"><a href="#4.2.3">.data</a></li><li class="level4"><a href="#4.2.4">.head</a></li><li class="level4"><a href="#4.2.5">.is</a></li><li class="level4"><a href="#4.2.6">.toString</a></li><li class="level4"><a href="#4.2.7">.type</a></li><li class="level4"><a href="#4.2.8">.status</a></li><li class="level3"><a href="#4.3">设计模式</a></li><li class="level3"><a href="#4.4">Generator</a></li><li class="level2"><a href="#5">第三方模块</a></li><li class="level3"><a href="#5.1">开发目录</a></li><li class="level3"><a href="#5.2">代码范例</a></li><li class="level4"><a href="#5.2.1">异常处理</a></li><li class="level4"><a href="#5.2.2">日志输出</a></li><li class="level3"><a href="#5.3">测试用例规范</a></li><li class="level3"><a href="#5.4">代码调试</a></li><li class="level3"><a href="#5.5">模块发布</a></li></ul>

</nav>
<article>
<div class='logo'></div>
<header>
<h1>Tianma();<sup>0.9.0</sup></h1>
<div class="comment">// All-purpose toybox</div>
</header>
<small>查看老版本的文档请<a href="./0.8.1/index.html">点击这里</a>.</small>
<blockquote>
<p>   欢迎使用<strong>天马</strong>，搭建一个HTTP服务器可以如此简单 :-)</p>
</blockquote>

<h2 id="1">入门</h2>
<h3 id="1.1">安装</h3>
<p>首先请安装<a href="http://nodejs.org">NodeJS</a>，然后在终端下使用以下命令安装天马。</p>
<pre><code>$ npm install tianma@0.9.x -g</code></pre>
<h3 id="1.2">使用</h3>
<p>安装好天马后，可以在终端下通过<code>tianma</code>命令来使用各种功能，例如查看帮助：</p>
<pre><code>$ tianma -h

  Usage: tianma [command] [config]
  ...</code></pre>
<h4 id="1.2.1">工作目录</h4>
<p>搭建服务器前一般需要创建一个工作目录。以下是一个典型的工作目录：</p>
<pre><code>- home/admin/www/         # 工作目录
    - htdocs/                 # 网站根目录
        index.html                # 一些静态文件
        ...                       ...
    config.js                # 默认配置文件</code></pre>
<h4 id="1.2.2">配置文件</h4>
<p>天马使用JS来配置服务器功能，我们可以把默认配置文件（<em>config.js</em>）的内容编辑如下，配置一个运行在80端口上的静态文件服务：</p>
<pre><code>var tianma = require(&#39;tianma&#39;);

tianma(80)
    .static(&#39;./htdocs&#39;);</code></pre>
<blockquote>
<p>   天马自动通过<code>NODE_PATH</code>环境变量来指定<code>tianma</code>所在位置，因此工作目录下不需要使用NPM本地安装<code>tianma</code>也可以使用<code>require(&#39;tianma&#39;)</code>。</p>
</blockquote>
<h4 id="1.2.3">启动和停止服务</h4>
<p>在工作目录下打开终端，通过以下命令可以控制服务。</p>
<pre><code>$ pwd
/home/admin/www                                  # 当前工作目录
...
$ tianma                                    # 启动服务
[23:37:28] Using &quot;/home/admin/www/config.js&quot;
[23:37:28] Press [Ctrl+C] to stop..
...
$ tianma start                              # 启动后台服务
[23:37:28] Using &quot;/home/admin/www/config.js&quot;
[23:37:28] Service started
...
$ tianma restart                            # 重启当前后台服务
[23:37:28] Service killed
[23:37:28] Using &quot;/home/admin/www/config.js&quot;
[23:37:28] Service started
...
$ tianma stop                               # 停止当前后台服务
[23:37:28] Service killed</code></pre>
<blockquote>
<p>   后台服务启动后，即使关闭当前终端，服务依然继续运行。</p>
</blockquote>
<p>另外，不使用默认配置文件时，可以通过<code>[config]</code>参数来指定配置文件路径。</p>
<pre><code>$ pwd
/home/admin/www                                  # 当前工作目录
$ tianma foo.js                             # 指定配置文件启动服务
[23:37:28] Using &quot;/home/admin/www/foo.js&quot;
...
$ tianma start bar.js                       # 指定配置文件启动后台服务
[23:37:28] Using &quot;/home/admin/www/bar.js&quot;
[23:37:28] Service started</code></pre>

<h2 id="2">配置文件</h2>
<p>编写配置文件时需要按以下步骤做三件事情：</p>
<ol>
<li><p>创建<em>主机</em>（Host）。</p>
</li>
<li><p>在主机上创建<em>流水线</em>（Pipeline）。</p>
</li>
<li><p>在流水线上使用<em>模块</em>（Filter）。</p>
</li>
</ol>
<h3 id="2.1">创建主机</h3>
<p>主机是提供服务的基本单元，可以通过<code>tianma()</code>函数创建。</p>
<pre><code>var tianma = require(&#39;tianma&#39;)

tianma(config)   // 创建一个主机</code></pre>
<h4 id="2.1.1">监听端口</h4>
<p>一个主机可以监听一个HTTP端口，通过<code>port</code>来指定。</p>
<pre><code>tianma({ port: 8080 })</code></pre>
<p>其它配置都使用默认值时，也可以使用以下<em>快捷配置</em>：</p>
<pre><code>tianma(8080)</code></pre>
<p>HTTP端口也使用默认值<code>80</code>时，配置可进一步简化如下：</p>
<pre><code>tianma()</code></pre>
<h4 id="2.1.2">IP绑定</h4>
<p>当服务器上有多个IP时，可以通过<code>ip</code>来指定绑定哪个IP提供服务。未指定时，绑定所有IP。</p>
<pre><code>tianma({ ip: &#39;127.0.0.1&#39;, port: 80 })</code></pre>
<h4 id="2.1.3">编码</h4>
<p>可以通过<code>charset</code>来指定主机在处理HTTP请求和响应时使用的文本编码。未指定时，默认使用<code>utf-8</code>。天马支持的编码类型请参考<a href="https://github.com/ashtuchkin/iconv-lite#supported-encodings">iconv-lite</a>。</p>
<pre><code>tianma({ charset: &#39;gbk&#39;, port: 80 })</code></pre>
<h4 id="2.1.4">HTTPS</h4>
<p>一个主机同时也可以监听一个HTTPS端口，通过<code>portssl</code>来指定。</p>
<pre><code>tianma({ portssl: 443 })</code></pre>
<p>天马使用<em>自制证书</em>提供HTTPS服务，为了避免浏览器安全警告，可以在浏览器中安装<em>天马根证书</em>（<code>{全局目录}/certificates/tianma.cer</code>）。</p>
<ul>
<li><p>IE</p>
<p>  双击<code>tianma.cer</code>，在弹出的对话框中选择<em>安装证书</em>，证书安装位置手动指定为<em>受信任的根证书颁发机构</em>，完成。</p>
</li>
<li><p>Chrome</p>
<p>  Windows下Chrome与IE共用一套证书系统，只需完成IE的安装步骤即可。Linux下按照<em>设置</em> -&gt; <em>显示高级设置</em> -&gt; <em>管理证书</em>的顺序打开对话框后，按照类似IE下的步骤安装根证书。</p>
</li>
<li><p>Firefox</p>
<p>  按照<em>选项</em> -&gt; <em>高级</em> -&gt; <em>加密</em> -&gt; <em>查看证书</em> -&gt; <em>认证</em> -&gt; <em>导入</em>的顺序，打开<code>tianma.cer</code>之后，在弹出的对话框中勾选上<em>使用该证书认证网站</em>，完成。</p>
</li>
<li><p>其它浏览器</p>
<p>  请依葫芦画瓢。</p>
</li>
</ul>
<blockquote>
<p>   天马通过<a href="http://en.wikipedia.org/wiki/Server_Name_Indication">SNI</a>技术同时为多个域名提供HTTPS服务，并且<em>动态地</em>为不同域名生成基于天马根证书签发的子证书。</p>
</blockquote>
<h3 id="2.2">创建流水线</h3>
<p>一个主机上需要使用<code>mount</code>方法创建一到多条流水线，主机在收到一个HTTP请求时，会交由与之匹配的流水线处理。</p>
<pre><code>tianma()
    .mount(&#39;foo.example.com&#39;)   // 创建一条流水线
        .static(&#39;./foo&#39;)
    .mount(&#39;bar.example.com&#39;)   // 创建另一条流水线
        .static(&#39;./bar&#39;)</code></pre>
<h4 id="2.2.1">路由规则</h4>
<p>使用<code>mount</code>方法创建流水线的同时，也定义了相应的路由规则。路由规则由<em>域名</em>和<em>路径</em>组成，支持通配符<code>*</code>和<code>?</code>。省略域名时，默认值为<code>*</code>，省略路径时，默认值为<code>/</code>。</p>
<ul>
<li><code>*</code>: 使用非贪婪模式匹配一到多个字符。</li>
<li><code>?</code>: 匹配一个字符。</li>
</ul>
<p>HTTP请求按以下原则与路由规则匹配：</p>
<ul>
<li><p><em>域名</em>优先于<em>路径</em>。</p>
</li>
<li><p><em>具体</em>规则优先于<em>通配</em>规则。</p>
</li>
</ul>
<p>以下是一些路由规则（左）和匹配结果（右）的例子：</p>
<pre><code>tianma()
    .mount(&#39;*.example.com&#39;)         // 匹配&#39;http://www.example.com/foo&#39;
        .static(&#39;./example&#39;)
    .mount(&#39;www.example.com/ba?/&#39;)  // 匹配&#39;http://www.example.com/bar/foo&#39;
        .static(&#39;./example&#39;)
    .mount(&#39;/&#39;)                     // 匹配&#39;http://www.sample.com/foo&#39;
        .static(&#39;./default&#39;)</code></pre>
<h4 id="2.2.2">默认流水线</h4>
<p>天马自带一条使用路由规则<code>/</code>的默认流水线，只需要使用默认流水线时，就可以省略<code>mount</code>方法，直接在默认流水线上使用模块。</p>
<pre><code>tianma()
    .static(&#39;./default&#39;)

/* 等价于 */

tianma()
    .mount(&#39;/&#39;)
        .static(&#39;./default&#39;)</code></pre>
<h3 id="2.3">使用模块</h3>
<p>一条流水线上可以使用一到多个模块，以决定流水线如何处理HTTP请求。天马<em>内置</em>了若干常用模块，可以按照链式调用的方式，使用模块名作为方法名，在新创建的流水线上按顺序使用。</p>
<pre><code>tianma()
    .mount(&#39;www.example.com&#39;)
        .compress(&#39;html&#39;, &#39;js&#39;, &#39;css&#39;)  // 使用数据压缩模块
        .static(&#39;./htdocs&#39;);            // 使用静态文件服务模块</code></pre>
<h4 id="2.3.1">模块层叠</h4>
<p>一条流水线上的模块按照<em>使用顺序</em>层叠在一起，因此流水线在处理不同的HTTP请求时，有以下几种方式：</p>
<ul>
<li><p>一个模块可以在处理完请求之后<em>直接返回</em>响应，这时后续模块不发挥作用。</p>
<pre><code>           request response
               v     ^   
               |     |   
  +------------|-----|---------------------------------+
  | filter A   `-----`                                 |
  +----------------------------------------------------+
  | filter B                                           |
  +----------------------------------------------------+</code></pre>
</li>
<li><p>一个模块可以先对请求做<em>部分处理</em>后，再将请求<em>传递</em>给后续模块处理，并在后续模块<em>返回</em>响应后，再对响应做一些<em>二次加工</em>。</p>
<pre><code>            request           response
               v                 ^
               |                 |
  +------------|-----------------|---------------------+
  | filter A   `-----.     .-----`                     |
  +------------------|-----|---------------------------+
  | filter B         `-----`                           |
  +----------------------------------------------------+</code></pre>
</li>
<li><p>一个模块甚至可以对请求做一些处理后，<em>多次</em>将请求传递给后续模块处理并收集响应，并最终返回一个<em>总体</em>响应。</p>
<pre><code>            request                       response
               v                             ^   
               |                             |   
  +------------|-----------------------------|---------+
  | filter A   `-----.     .-----.     .-----`         |
  +------------------|-----|-----|-----|---------------+
  | filter B         `-----`     `-----`               |
  +----------------------------------------------------+</code></pre>
</li>
</ul>
<h3 id="2.4">远程配置</h3>
<p>如果需要统一维护一份<em>公用配置文件</em>提供给多人使用，就可以把配置文件存放在一台HTTP静态文件服务器上，这样的配置被称为<em>远程配置</em>。</p>
<h4 id="2.4.1">使用方法</h4>
<p>通过<code>tianma(url)</code>函数可以加载和运行远程配置。</p>
<pre><code>tianma(&#39;http://www.example.com/some-config.js&#39;)</code></pre>
<p>想要更安全时，也可以使用HTTPS协议。</p>
<pre><code>tianma(&#39;https://www.example.com/some-config.js&#39;)</code></pre>
<p>远程配置需要使用者提供一些<em>参数</em>时，可以使用以下方式：</p>
<pre><code>tianma(&#39;http://www.example.com/some-config.js&#39;, {
    port: 8080,
    root: &#39;/home/admin/www/htdocs&#39;
});</code></pre>
<blockquote>
<p>   当存放在远程服务器上的配置文件的<em>最后修改日期</em>发生变动时，天马会<em>自动更新</em>本地缓存起来的配置文件。</p>
</blockquote>
<h4 id="2.4.2">编写方法</h4>
<p>编写远程配置的方法和普通配置文件类似，只不过远程配置中可通过全局变量<code>config</code>来访问使用者提供的参数。</p>
<pre><code>var tianma = require(&#39;tianma&#39;)

tianma({ port: config.port || 80 })      // 允许使用者自定义HTTP端口
    .static(config.root || &#39;./htdocs&#39;)   // 允许使用者自定义静态文件服务根目录</code></pre>

<h2 id="3">内置模块</h2>
<p>天马内置了一些常用模块，合理组合之后能满足很多常见需求。</p>
<h3 id="3.1">cache</h3>
<blockquote>
<p>   该模块将后续模块对<em>GET</em>请求的<em>200</em>响应缓存起来。在缓存有效期内，如果再次有URL相同的GET请求到达，该模块就直接返回缓存内容。</p>
</blockquote>
<ul>
<li><p>缓存有效期默认为1800秒。</p>
<pre><code>  tianma()
      .cache()
      .static()</code></pre>
</li>
<li><p>将缓存有效期置为3600秒。</p>
<pre><code>  tianma()
      .cache(3600)
      .static()</code></pre>
</li>
</ul>
<h3 id="3.2">combo</h3>
<blockquote>
<p>   当到达的<em>GET</em>请求的URL匹配以下格式时：</p>
<pre><code>   /base/??path1,path2,...,pathN?query</code></pre>
<p>   该模块将请求拆解为以下N个独立的请求后分别交给后续模块处理：</p>
<pre><code>   /base/path1?query
   /base/path2?query
   ...
   /base/pathN?query</code></pre>
<p>   如果后续模块返回的所有响应的<code>Content-Type</code>一致，该模块就将所有响应内容合并后返回。</p>
</blockquote>
<ul>
<li><p>通常用于合并JS/CSS文件请求，文件内容之间使用<code>\n</code>作为<em>内容分隔符</em>。</p>
<pre><code>  tianma()
      .combo()
      .static()</code></pre>
</li>
<li><p>该模块自动为合并后的JS/CSS生成<em>Source Map</em>以便于代码调试。</p>
</li>
<li><p>JS/CSS<em>自带的</em>Source Map会被<em>合并</em>在自动生成的Source Map当中。</p>
</li>
</ul>
<h3 id="3.3">compress</h3>
<blockquote>
<p>   如果到达的请求支持<code>gzip</code>或<code>deflate</code>两种压缩方式，该模块会对后续模块返回的响应进行<em>数据压缩</em>。</p>
</blockquote>
<ul>
<li><p><em>默认配置</em>下，对<code>js</code>、<code>css</code>和<code>html</code>启用压缩。</p>
<pre><code>  tianma()
      .compress()
      .static()</code></pre>
</li>
<li><p><em>自定义</em>需要压缩的文件类型。</p>
<pre><code>  tianma()
      .compress(&#39;js&#39;, &#39;css&#39;, &#39;svg&#39;)
      .static()</code></pre>
</li>
</ul>
<h3 id="3.4">rewrite</h3>
<blockquote>
<p>   如果到达的请求路径加参数（<code>req.path</code>）满足<em>匹配规则</em>，则根据<em>目标地址</em>的类型，该模块或对请求进行<em>路径重定向</em>，或进行<em>服务端代理</em>。</p>
</blockquote>
<ul>
<li><p>将任意请求<em>重定向</em>到某个目录下。</p>
<pre><code>  tianma()
      .rewrite({
          &#39;/build$1&#39;: /^(.*)/
      })
      .static()</code></pre>
</li>
<li><p>将对指定目录的请求<em>代理</em>到远程服务器。</p>
<pre><code>  tianma()
      .rewrite({
          &#39;/build$1&#39;: /^(.*)/,
          &#39;http://download.example.com$1&#39;: /^(\/file\/.*)/
      })
      .static()</code></pre>
</li>
</ul>
<h3 id="3.5">static</h3>
<blockquote>
<p>   该模块使用指定的根目录提供<em>静态文件服务</em>。如果根目录下存在请求的文件或目录，该模块直接返回<em>200</em>响应，否则该模块将响应置为<em>404</em>后，将请求继续交给后续模块处理。</p>
</blockquote>
<ul>
<li><p><em>默认配置</em>下，使用工作目录作为根目录。</p>
<pre><code>  tianma()
      .static()</code></pre>
</li>
<li><p>使用<em>快捷配置</em>指定根目录路径。</p>
<pre><code>  tianma()
      .static(&#39;./htdocs&#39;)</code></pre>
</li>
<li><p>请求的是一个目录时，可被自动重定向到指定的<em>索引文件</em>。</p>
<pre><code>  tianma()
      .static({ root: &#39;./htdocs&#39;, indexes: [ &#39;index.html&#39;, &#39;default.html&#39; ] })</code></pre>
</li>
<li><p>请求的是一个目录时，可<em>禁用</em>自动目录索引功能，改为返回一个<em>403</em>响应。</p>
<pre><code>  tianma()
      .static({ root: &#39;./htdocs&#39;, indexes: false })</code></pre>
</li>
</ul>
<h3 id="3.6">use</h3>
<blockquote>
<p>   使用<em>自定义模块</em>或<em>第三方模块</em>。使用第三方模块时，天马会在当前<em>配置文件所在目录</em>下查找并使用与指定模块名和版本号匹配的模块。如果没有找到，天马会使用<em>NPM</em>自动下载安装指定的模块。</p>
</blockquote>
<ul>
<li><p>使用自定义模块。</p>
<pre><code>  tianma()
      .use(function (req, res) {
          res.status(200).data(&#39;Hello World!&#39;);
          res();
      })</code></pre>
</li>
<li><p>通过<em>模块名</em>使用第三方模块，并传入模块配置。</p>
<pre><code>  tianma()
      .use(&#39;tianma-uglifyjs&#39;, { mangle: true })
      .static()</code></pre>
</li>
<li><p>指定第三方模块<em>版本号</em>。</p>
<pre><code>  tianma()
      .use(&#39;tianma-uglify@2.3.x&#39;)
      .static()</code></pre>
</li>
<li><p>指定第三方模块版本号和所在<em>仓库地址</em>。</p>
<pre><code>  tianma()
      .use(&#39;http://r.cnpmjs.org/tianma-uglify@2.3.x&#39;)
      .static()</code></pre>
</li>
</ul>

<h2 id="4">自定义模块</h2>
<p>当内置模块无法满足需求时，可以尝试编写<em>自定义模块</em>。自定义模块是一个函数，使用传入的<code>request</code>和<code>response</code>对象处理HTTP请求和响应。</p>
<pre><code>tianma()
    .use(function (req, res) {          // 使用自定义模块
        if (req.method() === &#39;GET&#39;) {
            res.status(200).data(&#39;200 OK&#39;);
        } else {
            res.status(403).data(&#39;403 Forbidden&#39;);
        }
        res();
    })</code></pre>
<h3 id="4.1">request</h3>
<p><code>request</code>对象包含了HTTP请求相关数据，对象上的所有方法支持<em>链式调用</em>。使用<code>request</code>对象时，虽然大多数情况下只需要从中<em>读取数据</em>，但是在例如请求重定向等情况下，就需要<em>修改数据</em>。</p>
<h4 id="4.1.1">.accepts</h4>
<blockquote>
<p>   判断请求是否支持某种类型。</p>
</blockquote>
<ul>
<li><p>通过文件类型或MIME来判断。</p>
<pre><code>  request
      .head(&#39;accept&#39;, &#39;text/html,text/css&#39;)

  request
      .accepts(&#39;html&#39;)  // =&gt; &#39;html&#39;
  request
      .accepts(&#39;text/html&#39;)  // =&gt; text/html
  request
      .accepts(&#39;text/*&#39;)  // =&gt; text/html
  request
      .accepts(&#39;text/plain&#39;)  // =&gt; false</code></pre>
</li>
<li><p>提供多组判断条件。</p>
<pre><code>  request
      .head(&#39;accept&#39;, &#39;text/html,text/css&#39;)

  request
      .accepts(&#39;js&#39;, &#39;html&#39;)  // =&gt; &#39;html&#39;
  request
      .accepts(&#39;js&#39;, &#39;css&#39;)  // =&gt; false</code></pre>
</li>
</ul>
<h4 id="4.1.2">.acceptsCharsets</h4>
<blockquote>
<p>   判断请求是否支持某种文本编码。</p>
</blockquote>
<ul>
<li><p>支持一到多组判断条件。</p>
<pre><code>  request
      .head(&#39;accept-charset&#39;, &#39;utf-8,utf-7;q=0.7&#39;)

  request
      .acceptsCharsets(&#39;utf-8&#39;, &#39;utf-7&#39;)  // =&gt; &#39;utf-8&#39;
  request
      .acceptsCharsets(&#39;gbk&#39;)  // =&gt; false</code></pre>
</li>
<li><p>读取支持的所有语言，自动忽略掉<code>Accept-Charset</code>中的参数。</p>
<pre><code>  request
      .head(&#39;accept-charset&#39;, &#39;utf-8,utf-7;q=0.7&#39;)

  request
      .acceptsCharsets()  // =&gt; [ &#39;utf-8&#39;, &#39;utf-7&#39; ]</code></pre>
</li>
</ul>
<h4 id="4.1.3">.acceptsEncodings</h4>
<blockquote>
<p>   判断请求是否支持某种数据压缩格式。</p>
</blockquote>
<ul>
<li><p>支持一到多组判断条件。</p>
<pre><code>  request
      .head(&#39;accept-encoding&#39;, &#39;gzip,deflate&#39;)

  request
      .acceptsEncodings(&#39;gzip&#39;, &#39;deflate&#39;)  // =&gt; &#39;gzip&#39;
  request
      .acceptsEncodings(&#39;sdch&#39;)  // =&gt; false</code></pre>
</li>
<li><p>读取支持的所有压缩格式。</p>
<pre><code>  request
      .head(&#39;accept-encoding&#39;, &#39;gzip,deflate&#39;)

  request
      .acceptsEncodings()  // =&gt; [ &#39;gzip&#39;, &#39;deflate&#39; ]</code></pre>
</li>
</ul>
<h4 id="4.1.4">.acceptsLanguages</h4>
<blockquote>
<p>   判断请求是否支持某种语言。</p>
</blockquote>
<ul>
<li><p>支持一到多组判断条件。</p>
<pre><code>  request
      .head(&#39;accept-language&#39;, &#39;en-US,zh-CN;q=0.7&#39;)

  request
      .acceptsLanguages(&#39;en-US&#39;, &#39;zh-CN&#39;)  // =&gt; &#39;en-US&#39;
  request
      .acceptsLanguages(&#39;zh-TW&#39;)  // =&gt; false</code></pre>
</li>
<li><p>读取支持的所有语言，自动忽略掉<code>Accept-Language</code>中的参数。</p>
<pre><code>  request
      .head(&#39;accept-language&#39;, &#39;en-US,zh-CN;q=0.7&#39;)

  request
      .acceptsLanguages()  // =&gt; [ &#39;en-US&#39;, &#39;zh-CN&#39; ];</code></pre>
</li>
</ul>
<h4 id="4.1.5">.charset</h4>
<blockquote>
<p>   读取或修改请求使用的文本编码，默认值由创建主机时的配置决定。</p>
</blockquote>
<pre><code>request
    .charset(&#39;gbk&#39;)
    .charset()  // =&gt; &#39;gbk&#39;</code></pre>
<h4 id="4.1.6">.cookie</h4>
<blockquote>
<p>   读取Cookie字段。</p>
</blockquote>
<pre><code>request
    .head(&#39;cookie&#39;, &#39;foo=1&amp;bar=2&#39;)
    .cookie(&#39;foo&#39;) // =&gt; &#39;1&#39;

request
    .cookie(&#39;baz&#39;)  // =&gt; &#39;&#39;</code></pre>
<h4 id="4.1.7">.data</h4>
<blockquote>
<p>   以二进制形式读取或修改请求数据。</p>
</blockquote>
<ul>
<li><p>读写请求数据。</p>
<pre><code>  request
      .data(new Buffer(&#39;Hello&#39;))
      .data()  // =&gt; &lt;Buffer 48 65 6c 6c 6f&gt;</code></pre>
</li>
<li><p>以字符串形式修改请求数据，字符串按照当前文本编码<em>自动转换</em>为二进制数据。</p>
<pre><code>  request
      .data(&#39;Hello&#39;)
      .data()  // =&gt; &lt;Buffer 48 65 6c 6c 6f&gt;</code></pre>
</li>
<li><p>使用<em>数组</em>修改请求数据。</p>
<pre><code>  request
      .data([ &#39;He&#39;, new Buffer(&#39;llo&#39;) ])
      .data()  // =&gt; &lt;Buffer 48 65 6c 6c 6f&gt;</code></pre>
</li>
</ul>
<h4 id="4.1.8">.form</h4>
<blockquote>
<p>   读取表单数据中的某个字段。</p>
</blockquote>
<ul>
<li><p>通过<em>字段名</em>读取<em>普通</em>字段。</p>
<pre><code>  // &lt;input type=&quot;text&quot; name=&quot;username&quot; /&gt;
  request
      .form(&#39;username&#39;) // =&gt; &#39;Jim Green&#39;</code></pre>
</li>
<li><p>通过<em>字段名</em>读取<em>文件</em>字段。</p>
<pre><code>  // &lt;input type=&quot;file&quot; name=&quot;photo&quot; /&gt;
  var photo = request.form(&#39;photo&#39;)

  photo           // =&gt; &lt;Buffer FF D8 FF E1 2E A5 45 78 ...&gt;
  photo.mime      // =&gt; &#39;image/png&#39;
  photo.filename  // =&gt; &#39;jim_green.png&#39;</code></pre>
</li>
</ul>
<h4 id="4.1.9">.head</h4>
<blockquote>
<p>   读取或修改请求头字段。</p>
</blockquote>
<ul>
<li><p>修改和读取单个头字段。</p>
<pre><code>  request
      .head(&#39;host&#39;, &#39;example.com&#39;)
      .head(&#39;host&#39;)  // =&gt; &#39;example.com&#39;</code></pre>
</li>
<li><p>批量修改多个头字段，并读取整个请求头。</p>
<pre><code>  request
      .head(&#39;host&#39;, &#39;example.com&#39;)
      .head({
          &#39;host&#39;: &#39;sample.com&#39;,
          &#39;referer&#39;: &#39;http://localhost/&#39;
      })
      .head()  // =&gt; { host: &#39;sample.com&#39;, referer: &#39;http://localhost/&#39; }</code></pre>
</li>
</ul>
<h4 id="4.1.10">.ip</h4>
<blockquote>
<p>   读取或修改请求来源IP。</p>
</blockquote>
<pre><code>request
    .ip(&#39;127.0.0.1&#39;)
    .ip()  // =&gt; &#39;127.0.0.1&#39;</code></pre>
<h4 id="4.1.11">.is</h4>
<blockquote>
<p>   判断请求是否属于某种类型。</p>
</blockquote>
<ul>
<li><p>通过文件类型或MIME来判断。</p>
<pre><code>  request
      .type(&#39;html&#39;)

  request
      .is(&#39;html&#39;)  // =&gt; &#39;html&#39;
  request
      .is(&#39;text/html&#39;)  // =&gt; &#39;text/html&#39;
  request
      .is(&#39;text/*&#39;)  // =&gt; &#39;text/html&#39;
  request
      .is(&#39;css&#39;)  // =&gt; false</code></pre>
</li>
<li><p>提供多组判断条件。</p>
<pre><code>  request
      .type(&#39;html&#39;)

  request
      .is(&#39;css&#39;, &#39;html&#39;)  // =&gt; &#39;html&#39;
  request
      .is(&#39;css&#39;, &#39;js&#39;)  // =&gt; false</code></pre>
</li>
</ul>
<h4 id="4.1.12">.method</h4>
<blockquote>
<p>   读取或修改请求方法。</p>
</blockquote>
<pre><code>request
    .method(&#39;post&#39;)
    .method()  // =&gt; &#39;POST&#39;</code></pre>
<h4 id="4.1.13">.toString</h4>
<blockquote>
<p>   以字符串形式读取请求数据。</p>
</blockquote>
<pre><code>request
    .data(new Buffer(&#39;Hello&#39;))
    .toString()  // =&gt; &quot;Hello&quot;

request + &#39;!&#39;;  // =&gt; &#39;Hello!&#39;</code></pre>
<h4 id="4.1.14">.type</h4>
<blockquote>
<p>   读取或修改请求类型。</p>
</blockquote>
<ul>
<li><p>读取请求类型，自动忽略掉<code>Content-Type</code>中例如<code>charset</code>的参数。</p>
<pre><code>  request
      .head(&#39;content-type&#39;, &#39;text/html; charset=utf-8&#39;)
      .type()  // =&gt; text/html</code></pre>
</li>
<li><p>通过多种方式修改请求类型，并根据当前<em>文本编码</em>自动在<code>Content-Type</code>中加上<code>charset</code>参数。</p>
<pre><code>  request
      .type(&#39;text/html&#39;)
      .head(&#39;content-type&#39;)  // =&gt; text/html; charset=utf-8

  request
      .type(&#39;html&#39;)
      .head(&#39;content-type&#39;)  // =&gt; text/html; charset=utf-8

  request
      .type(&#39;.html&#39;)
      .head(&#39;content-type&#39;)  // =&gt; text/html; charset=utf-8

  request
      .type(&#39;index.html&#39;)
      .head(&#39;content-type&#39;)  // =&gt; text/html; charset=utf-8</code></pre>
</li>
</ul>
<h4 id="4.1.15">.url</h4>
<blockquote>
<p>   读取或修改请求URL。读取时，总是返回完整URL。修改时，可以传入完整URL或URL片段。一个完整的URL由以下片段组成：</p>
<pre><code>                               host              path
                         --------------- ----------------------
    http: // user:pass @ host.com : 8080 /p/a/t/h ?query=string
    -----    ---------   --------   ---- -------- -------------
   protocol     auth     hostname   port pathname     search</code></pre>
</blockquote>
<ul>
<li><p>使用<em>完整</em>URL或URL<em>片段</em>修改URL。</p>
<pre><code>  request
      .url(&#39;http://hostname/path/name?key=value&#39;)  // 修改整个URL
      .url()  // =&gt; &#39;http://hostname/path/name?key=value&#39;

  request
      .url(&#39;https:&#39;)  // 修改协议头
      .url()  // =&gt; &#39;https://hostname/path/name?key=value&#39;

  request
      .url(&#39;//example.com&#39;)  // 修改域名
      .url()  // =&gt; &#39;https://example.com/path/name?key=value&#39;

  request
      .url(&#39;/foo/bar&#39;)  // 修改路径
      .url()  // =&gt; &#39;https://example.com/foo/bar?key=value&#39;

  request
      .url(&#39;?a=b&#39;)  // 修改参数
      .url()  // =&gt; &#39;https://example.com/foo/bar?a=b&#39;</code></pre>
</li>
<li><p>通过<strong>只读属性</strong>读取当前URL的各个片段。URL修改后，各属性值会<em>自动更新</em>。</p>
<pre><code>  request
      .url(&#39;http://user:pass@host.com:8080/p/a/t/h?query=string&#39;)

  request.protocol  // =&gt;  &#39;http:&#39;
  request.auth      // =&gt;  &#39;user:pass&#39;
  request.hostname  // =&gt;  &#39;host.com&#39;
  request.port      // =&gt;  &#39;8080&#39;
  request.host      // =&gt;  &#39;host.com:8080&#39;
  request.pathname  // =&gt;  &#39;/p/a/t/h&#39;
  request.search    // =&gt;  &#39;?query=string&#39;
  request.path      // =&gt;  &#39;/p/a/t/h?query=string&#39;</code></pre>
</li>
<li><p>通过<strong>只读属性</strong>读取<code>search</code>片段的键值对<em>解析结果</em>。</p>
<pre><code>  request
      .url(&#39;?foo=1&amp;foo=2&amp;bar=3&#39;)
      .query  // =&gt; { foo: [ &#39;1&#39;, &#39;2&#39; ], bar: &#39;3&#39; }</code></pre>
</li>
</ul>
<h3 id="4.2">response</h3>
<p><code>response</code>对象包含了HTTP响应相关数据，对象上的所有方法支持<em>链式调用</em>。</p>
<h4 id="4.2.1">.charset</h4>
<blockquote>
<p>   读取或修改响应使用的文本编码，默认值由创建主机时的配置决定。使用方法同<code>request.charset</code>。</p>
</blockquote>
<h4 id="4.2.2">.cookie</h4>
<blockquote>
<p>   向响应头中添加一个<code>Set-Cookie</code>字段。</p>
</blockquote>
<ul>
<li><p>通过<em>字段名</em>和<em>字段值</em>添加一个Cookie。</p>
<pre><code>  response
      .cookie(&#39;foo&#39;, &#39;bar&#39;)
      .cookie(&#39;bar&#39;, &#39;baz&#39;)
      .head(&#39;set-cookie&#39;)  // =&gt; [ &#39;foo=bar;&#39;, &#39;bar=baz&#39; ]</code></pre>
</li>
<li><p>指定Cookie参数。</p>
<pre><code>  response
      .cookie(&#39;foo&#39;, &#39;bar&#39;, {
          maxAge: 0,
          domain: &#39;localhost&#39;,
          path: &#39;/&#39;,
          expires: new Date(),
          httpOnly: true,
          secure: true
      })
      .head(&#39;set-cookie&#39;)  // =&gt; &#39;foo=bar; Domain=localhost; Path=/; Expires=Tue, 04 Dec 2012 03:03:14 GMT; HttpOnly; Secure&#39;</code></pre>
</li>
</ul>
<h4 id="4.2.3">.data</h4>
<blockquote>
<p>   以二进制形式读取或修改响应数据，使用方法同<code>request.data</code>。</p>
</blockquote>
<h4 id="4.2.4">.head</h4>
<blockquote>
<p>   读取或修改响应头字段，使用方法同<code>request.head</code>。</p>
</blockquote>
<h4 id="4.2.5">.is</h4>
<blockquote>
<p>   判断响应是否属于某种类型，使用方法同<code>request.is</code>。</p>
</blockquote>
<h4 id="4.2.6">.toString</h4>
<blockquote>
<p>   以字符串形式读取响应数据，使用方法同<code>request.toString</code>。</p>
</blockquote>
<h4 id="4.2.7">.type</h4>
<blockquote>
<p>   读取或修改响应类型，使用方法同<code>request.type</code>。</p>
</blockquote>
<h4 id="4.2.8">.status</h4>
<blockquote>
<p>   读取或修改响应状态码。</p>
</blockquote>
<pre><code>response
    .status(200)
    .status();  // =&gt; 200</code></pre>
<h3 id="4.3">设计模式</h3>
<p>在编写自定义模块时，有以下三种常用模式：</p>
<ul>
<li><p>模块可以在处理完请求后，直接通过<code>res()</code>返回响应。如果在处理过程中有异常发生，模块可以通过<code>res(err)</code>抛出异常，天马会自动返回一个500响应。</p>
<pre><code>  // 读取请求的文件
  function readFile(req, res) {
      fs.readFile(req.pathname, function (err, data) {
          if (err) {
              res(err);    // 抛出异常
          } else {
              res.status(200).data(data);
              res();       // 返回响应
          }
      });
  }

  tianma()
      .use(readFile)</code></pre>
</li>
<li><p>模块可以先部分处理请求，然后通过<code>req(callback)</code>将请求交后给后续模块处理，待后续模块完成处理后，再接着完成剩余工作。</p>
<pre><code>  // 统计后续模块处理请求的耗时
  function profile(req, res) {
      var start = new Date;     // 完成部分工作

      req(function (err) {      // 将请求交给后续模块
          if (err) {            // 原样抛出后续模块产生的异常
              res(err);
          } else {              // 完成剩余工作
              res.head(&#39;x-process-time&#39;, new Date - start);
              res();
          }
      });
  }

  tianma()
      .use(profile)
      .use(readFile)</code></pre>
</li>
<li><p>模块可以多次通过<code>req(callback)</code>将修改后的请求交给后续模块处理并收集处理结果，并最终返回一个总体响应。</p>
<pre><code>  // 简单处理文件形如`/base/??file1,file2`的合并请求
  function combo(req, res) {
      var parts = req.path.split(&#39;??&#39;),
          base = parts[0],
          pathnames = parts[1].split(&#39;,&#39;),
          data = [];

      (function next(i) {
          if (i &lt; pathnames.length) {
              req.url(base + pathnames[i]);   // 将请求路径修改为某个文件路径
              req(function (err) {            // 将请求交给后续模块
                  if (err) {
                      res(err);               // 发生任何异常时直接抛出
                  } else {
                      data.push(res.data());  // 收集请求处理结果
                      next(i + 1);            // 再来一次
                  }
              });
          } else {                            // 所有文件请求完成
              res.data(data);
              res();
          }
      }(0));
  }

  tianma()
      .use(combo)
      .use(readFile)</code></pre>
</li>
</ul>
<h3 id="4.4">Generator</h3>
<p>如果天马运行在NodeJS <code>v0.11.x</code>版本以上，还可以使用<em>Generator</em>编写模块，以简化<em>异步操作</em>与<em>异常处理</em>。并且，Generator模块中<em>不需要</em>显示调用<code>res()</code>来返回响应。</p>
<pre><code>// 使用Generator简化上例中profile函数的编写
function* profile(req, res) {
    var start = new Date;                          // 完成部分工作
    yield req;                                     // 将请求交给后续模块
    res.head(&#39;x-process-time&#39;, new Date - start);  // 完成剩余工作
}

// 使用Generator简化上例中combo函数的编写
function* combo(req, res) {
    var parts = req.path.split(&#39;??&#39;),
        base = parts[0],
        pathnames = parts[1].split(&#39;,&#39;),
        data = [];

    for (var i = 0, len = pathnames.length; i &lt; len; ++i) {
        req.url(base + pathnames[i]);           // 将请求路径修改为某个文件路径
        yield req;                              // 将请求交给后续模块
        data.push(res.data());
    }

    res.data(data);                             // 所有文件请求完成
}

tianma()
    .use(profile)   // 使用Generator
    .use(combo)     // 使用Generator
    .use(readFile)  // 使用普通函数</code></pre>

<h2 id="5">第三方模块</h2>
<p>第三方模块也属于自定义模块，但是需要<em>封装</em>为独立的NodeJS模块以便于发布到NPM上提供给其他用户使用。此外，第三方模块对<em>代码规范</em>与<em>代码质量</em>有更高的要求，毕竟没人愿意使用不好的模块。</p>
<h3 id="5.1">开发目录</h3>
<p>编写第三方模块之前一般需要准备一个<em>开发目录</em>，便于<em>组织代码</em>和<em>调试代码</em>。以下是一个典型的开发目录：</p>
<pre><code>- home/admin/dev/             # 开发目录
    - node_modules/               # 模块目录
        - tianma-profile/              # 开发中的第三方模块
            test/                         # 存放测试用例
            index.js                      # 第三方模块代码
            package.json                  # 模块描述文件
            README.md                     # 文档
    config.js                     # 调试第三方模块使用的天马配置文件</code></pre>
<h3 id="5.2">代码范例</h3>
<p>第三方模块需要允许用户通过参数配置模块行为，因此需要提供一个模块<em>工厂函数</em>，才能够通过天马内置的<code>use</code>模块加载。以下是一个第三方模块代码的标准范例：</p>
<pre><code>// tianma-profile/index.js

/* 工厂函数，支持传入配置对象 */
module.exports = function (config) {
    /* 初始化模块配置 */

    var keyName = (config || {}).keyName || &#39;x-process-time&#39;;

    /* 返回模块函数 */

    return function (req, res) {
        var start = new Date;

        req(function (err) {
            if (err) {
                res(err);
            } else {
                res.head(keyName, new Date() - start);
                res();
            }
        });
    };
};</code></pre>
<h4 id="5.2.1">异常处理</h4>
<p>待补充。</p>
<h4 id="5.2.2">日志输出</h4>
<p>待补充。</p>
<h3 id="5.3">测试用例规范</h3>
<p>待补充。</p>
<h3 id="5.4">代码调试</h3>
<p>可以通过天马内置的<code>use</code>模块加载和调试开发中的第三方模块。</p>
<pre><code>// config.js
var tianma = require(&#39;tianma&#39;);

tianma()
    .use(&#39;tianma-profile&#39;, { keyName: &#39;x-render-time&#39; })
    .static();</code></pre>
<h3 id="5.5">模块发布</h3>
<p>使用标准的<code>npm publish</code>命令将开发好的第三方模块发布到NPM上即可。此外，为了便于使用者搜索到天马的第三方模块，建议模块名以<code>tianma-</code>为前缀。</p>


<footer>
<p>© 2011-2014 Alibaba.com, Inc.</p>

</footer>
</article>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48219354-1', 'nqdeng.github.io');
  ga('send', 'pageview');

(function () {
	var wrapper = document.getElementById('wrapper'),
		article = document.getElementsByTagName('article')[0],
		menu = document.getElementById('menu');

	menu.addEventListener &&
	menu.addEventListener('click', function (e) {
		if (!wrapper.className) {
			wrapper.className = 'show-menu';
		} else {
			wrapper.className = '';
		}
	});

	article.addEventListener &&
	article.addEventListener('click', function (e) {
		wrapper.className = '';
	});
}());
</script>
</div>
</body>
</html>